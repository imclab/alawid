<html>

<head>
<title>WebGL Test</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">

<script type="text/javascript" src="glMatrix-0.9.5.min.js"></script>
<script type="text/javascript" src="webgl-utils.js"></script>
<script type="text/javascript" src="objects.js"></script>
<script type="text/javascript" src="webgl-core.js"></script>

<script type="text/javascript">

	var curProg;
	var perVertexProgram;
	var perFragmentProgram;

	function initShaders() {
		perVertexProgram = createProgram("per-vertex-lighting.vert", "per-vertex-lighting.frag");
		perFragmentProgram = createProgram("per-fragment-lighting.vert", "per-fragment-lighting.frag");
	}

	var moonTexture;
	var crateTexture;

	function initTextures() {
		moonTexture = loadTexture("textures/moon.png");
		crateTexture = loadTexture("textures/crate.png");
	}

	var pressedKeys = {};

	function handleKeyDown(event) {
		pressedKeys[event.keyCode] = true;
	}

	function handleKeyUp(event) {
		pressedKeys[event.keyCode] = false;
	}

	var pitch = 0;
	var pitchRate = 0;

	var yaw = 0;
	var yawRate = 0;

	var xPos = 0;
	var yPos = 0.4;
	var zPos = 0;

	var speed = 0;

	function handleKeys() {
		if (pressedKeys[33]) {
			// Page Up
			pitchRate = 0.1;
		} else if (pressedKeys[34]) {
			// Page Down
			pitchRate = -0.1;
		} else {
			pitchRate = 0;
		}

		if (pressedKeys[37] || pressedKeys[65]) {
			// Left cursor key or A
			yawRate = 0.1;
		} else if (pressedKeys[39] || pressedKeys[68]) {
			// Right cursor key or D
			yawRate = -0.1;
		} else {
			yawRate = 0;
		}

		if (pressedKeys[38] || pressedKeys[87]) {
			// Up cursor key or W
			speed = 0.003;
		} else if (pressedKeys[40] || pressedKeys[83]) {
			// Down cursor key
			speed = -0.003;
		} else {
			speed = 0;
		}

	}
	
	var cube;
	var moon;
	var moonAngle = 180;
	var cubeAngle = 0;

	function drawScene() {
		gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
		gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

		mat4.perspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, 100.0, pMatrix);

		var perFragmentLighting = document.getElementById("per-fragment").checked;
		if (perFragmentLighting) {
			curProg = perFragmentProgram;
		} else {
			curProg = perVertexProgram;
		}
		gl.useProgram(curProg);

		var lighting = document.getElementById("lighting").checked
		gl.uniform1i(curProg.useLightingUniform, lighting);
		if (lighting) {
			var ambient = vec3.create([0.2, 0.2, 0.2]);
			var diffuse = vec3.create([0.8, 0.8, 0.8]);
			var lightPos = vec3.create([0.0, 0.0, -5.0]);
			gl.uniform3f(curProg.ambientColorUniform, ambient[0], ambient[1], ambient[2]);
			gl.uniform3f(curProg.pointLightingColorUniform, diffuse[0], diffuse[1], diffuse[2]);
			gl.uniform3f(curProg.pointLightingLocationUniform, lightPos[0], lightPos[1], lightPos[2]);
		}

		var textures = document.getElementById("textures").checked;
		gl.uniform1i(curProg.useTexturesUniform, textures);

		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0, 0, -5]);
		mat4.rotate(mvMatrix, degToRad(30), [1, 0, 0]);

		mvPushMatrix();
		mat4.rotate(mvMatrix, degToRad(moonAngle), [0, 1, 0]);
		mat4.translate(mvMatrix, [2, 0, 0]);
		gl.activeTexture(gl.TEXTURE0);
		gl.bindTexture(gl.TEXTURE_2D, moonTexture);
		gl.uniform1i(curProg.samplerUniform, 0);

		moon.draw();
		mvPopMatrix();

		mvPushMatrix();
		mat4.rotate(mvMatrix, degToRad(cubeAngle), [0, 1, 0]);
		mat4.translate(mvMatrix, [1.25, 0, 0]);

		gl.activeTexture(gl.TEXTURE0);
		gl.bindTexture(gl.TEXTURE_2D, crateTexture);
		gl.uniform1i(curProg.samplerUniform, 0);

		cube.draw();
		mvPopMatrix();
	}


	var lastTime = 0;

	function animate() {
		var timeNow = new Date().getTime();
		if (lastTime != 0) {
			var elapsed = timeNow - lastTime;

			moonAngle += 0.05 * elapsed;
			cubeAngle += 0.05 * elapsed;
		}
		lastTime = timeNow;
	}


	function tick() {
		requestAnimFrame(tick);
		handleKeys();
		drawScene();
		animate();
	}


	function webGLStart() {
		var canvas = document.getElementById("glcanvas");
		initGL(canvas);
		initShaders();
		initBuffers();
		initTextures();

		gl.clearColor(0.0, 0.0, 0.0, 1.0);
		gl.enable(gl.DEPTH_TEST);

		document.onkeydown = handleKeyDown;
		document.onkeyup = handleKeyUp;

		tick();
	}

</script>


</head>


<body onload="webGLStart();">

	<canvas id="glcanvas" style="border: none;" width="500" height="500"></canvas>
	<br/>

	<input type="checkbox" id="lighting" checked /> Lighting &nbsp;|&nbsp;
	<input type="checkbox" id="per-fragment" checked /> Per-fragment lighting &nbsp;|&nbsp;
	<input type="checkbox" id="textures" checked /> Texturing
	<br/>

</body>

</html>
